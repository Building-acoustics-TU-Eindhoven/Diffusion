

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>acousticDE.FiniteDifferenceMethod.FDMfunctions &mdash; Diffusion Equation for Acoustics 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Diffusion Equation for Acoustics
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Software Presentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Overview.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Use:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Finite%20Different%20Method%20Use.html">Finite Different Method Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Finite%20Volume%20Method%20Use.html">Finite Volume Method Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Auralization%20Use.html">Auralization Use</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Theory:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../DocumentationFDM.html">Diffusion Equation Finite Different Method (FDM) documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../DocumentationFVM.html">Diffusion Equation Finite Volume Method (FVM) Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../DocumentationAuralization.html">Auralization Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../acousticDE/FDMfunctions.html">FDM functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acousticDE/FVMfunctions.html">FVM functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acousticDE/ReverberationFunctions.html">Reverberation functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acousticDE/Auralizationfunctions.html">Auralization functions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Finite%20Different%20Method%20Demo%20Tutorial.html">Finite Different Method Demo Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Finite%20Volume%20Method%20Demo%20Tutorial.html">Finite Volume Method Demo Tutorial</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Diffusion Equation for Acoustics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">acousticDE.FiniteDifferenceMethod.FDMfunctions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for acousticDE.FiniteDifferenceMethod.FDMfunctions</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Feb 28 10:39:42 2023</span>

<span class="sd">@author: Ilaria Fichera</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#Code developed by Ilaria Fichera for the analysis of the FDM method Du Fort &amp; Frankel solving the 3D diffusion equation with one intermittent omnidirectional sound source</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">types</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">acousticDE.FiniteDifferenceMethod.FunctionClarity</span><span class="w"> </span><span class="kn">import</span> <span class="n">clarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acousticDE.FiniteDifferenceMethod.FunctionDefinition</span><span class="w"> </span><span class="kn">import</span> <span class="n">definition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acousticDE.FiniteDifferenceMethod.FunctionCentreTime</span><span class="w"> </span><span class="kn">import</span> <span class="n">centretime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">acousticDE.FiniteDifferenceMethod.FunctionRT</span><span class="w"> </span><span class="kn">import</span> <span class="n">t60_decay</span>

<span class="c1">#%%</span>
<span class="c1">###############################################################################</span>
<span class="c1">#CALCULATION SECTION</span>
<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="number_freq">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.number_freq">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">number_freq</span><span class="p">(</span><span class="n">num_octave</span><span class="p">,</span><span class="n">fc_high</span><span class="p">,</span><span class="n">fc_low</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the frequency array and the number of frequency bands.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_octave : int</span>
<span class="sd">        Number of octaves to calculate (1 or 3 octaves).</span>
<span class="sd">    fc_high : int</span>
<span class="sd">        The highest frequency in the calculation.</span>
<span class="sd">    fc_low : int</span>
<span class="sd">        The lowest frequency in the calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nBands : int</span>
<span class="sd">        Number of frequency bands.</span>
<span class="sd">    center_freq : list of float</span>
<span class="sd">        Array of all the frequencies to calculate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_frequencies</span>  <span class="o">=</span> <span class="n">num_octave</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">fc_high</span><span class="o">/</span><span class="n">fc_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">nBands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_octave</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">fc_high</span><span class="o">/</span><span class="n">fc_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">center_freq</span> <span class="o">=</span> <span class="n">fc_low</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x_frequencies</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_octave</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">nBands</span><span class="p">,</span> <span class="n">center_freq</span></div>




<span class="c1">#Room characteristics</span>
<div class="viewcode-block" id="room_charact">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.room_charact">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">room_charact</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the total surface and volume of the room.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    length : float</span>
<span class="sd">        length of the room in meters.</span>
<span class="sd">    width : float</span>
<span class="sd">        Width of the room in meters.</span>
<span class="sd">    height : float</span>
<span class="sd">        Height of the room in meters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S1 : float</span>
<span class="sd">        Surface area of the Surface 1 (floor).</span>
<span class="sd">    S2 : float</span>
<span class="sd">        Surface area of the Surface 2 (ceiling).</span>
<span class="sd">    S3 : float</span>
<span class="sd">        Surface area of the Surface 3 (wall front).</span>
<span class="sd">    S4 : float</span>
<span class="sd">        Surface area of the Surface 4 (wall back).</span>
<span class="sd">    S5 : float</span>
<span class="sd">        Surface area of the Surface 5 (wall left).</span>
<span class="sd">    S6 : float</span>
<span class="sd">        Surface area of the Surface 6 (wall right).</span>
<span class="sd">    S : float</span>
<span class="sd">        Total surface area of the room</span>
<span class="sd">    V : float</span>
<span class="sd">        Volume of the room</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">S1</span><span class="p">,</span><span class="n">S2</span> <span class="o">=</span> <span class="n">length</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">length</span><span class="o">*</span><span class="n">width</span> <span class="c1">#xy planes</span>
    <span class="n">S3</span><span class="p">,</span><span class="n">S4</span> <span class="o">=</span> <span class="n">length</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">length</span><span class="o">*</span><span class="n">height</span> <span class="c1">#xz planes</span>
    <span class="n">S5</span><span class="p">,</span><span class="n">S6</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span> <span class="c1">#yz planes</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">length</span><span class="o">*</span><span class="n">width</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">length</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">2</span> <span class="c1">#Total Surface Area[m2]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">length</span><span class="o">*</span><span class="n">width</span><span class="o">*</span><span class="n">height</span> <span class="c1">#Volume of the room [m^3]</span>
    <span class="k">return</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">S3</span><span class="p">,</span> <span class="n">S4</span><span class="p">,</span> <span class="n">S5</span><span class="p">,</span> <span class="n">S6</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">V</span></div>



<span class="c1">#Creating of meshgrid</span>
<div class="viewcode-block" id="create_mesh">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.create_mesh">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_mesh</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the 3D mesh of the room.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    length : float</span>
<span class="sd">        length of the room in meters.</span>
<span class="sd">    width : float</span>
<span class="sd">        Width of the room in meters.</span>
<span class="sd">    height : float</span>
<span class="sd">        Height of the room in meters.</span>
<span class="sd">    dx : float</span>
<span class="sd">        distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">    dy : float</span>
<span class="sd">        distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">    dz : float</span>
<span class="sd">        distance step between mesh points in the z axis (recommended equal to dx)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : array of floats</span>
<span class="sd">        Linspace of the mesh point in the x axis.</span>
<span class="sd">    y : array of floats</span>
<span class="sd">        Linspace of the mesh point in the y axis.</span>
<span class="sd">    z : array of floats</span>
<span class="sd">        Linspace of the mesh point in the z axis.</span>
<span class="sd">    Nx : int</span>
<span class="sd">        Number of mesh points in the x direction.</span>
<span class="sd">    Ny : int</span>
<span class="sd">        Number of mesh points in the y direction.</span>
<span class="sd">    Nz : int</span>
<span class="sd">        Number of mesh points in the z direction.</span>
<span class="sd">    xx : array of floats</span>
<span class="sd">        3D matrix for the x coordinates</span>
<span class="sd">    yy : array of floats</span>
<span class="sd">        3D matrix for the y coordinates</span>
<span class="sd">    zz : array of floats</span>
<span class="sd">        3D matrix for the z coordinates</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="c1">#mesh points in space x direction</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">+</span><span class="n">dy</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="c1">#mesh points in space y direction</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">+</span><span class="n">dz</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span> <span class="c1">#mesh points in space z direction</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1">#number of point in the x direction</span>
    <span class="n">Ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1">#number of point in the y direction</span>
    <span class="n">Nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="c1">#number of point in the z direction</span>
    <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="c1">#Return coordinate matrices from coordinate vectors; create the 3D grid</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">zz</span></div>


<span class="c1">#Absorption term for boundary conditions </span>
<div class="viewcode-block" id="abs_term">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.abs_term">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">abs_term</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">c0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the absorption term (Sabine, Eyring or Modified)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        th : int</span>
<span class="sd">            The options for the absorption term; Sabine (th=1), Eyring (th=2) and modified by Xiang (th=3)</span>
<span class="sd">        alpha : list</span>
<span class="sd">            Absrption coefficient for each frequency</span>
<span class="sd">        c0 : int </span>
<span class="sd">            Speed of sound </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Absx_array : array of floats</span>
<span class="sd">            Calculated absorption term for each absorption coefficient for each frequency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Absx_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">abs_coeff</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="c1">#print(abs_coeff)</span>
        <span class="k">if</span> <span class="n">th</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Absx</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span><span class="o">*</span><span class="n">abs_coeff</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="c1">#Sabine</span>
        <span class="k">elif</span> <span class="n">th</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Absx</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">abs_coeff</span><span class="p">)))</span><span class="o">/</span><span class="mi">4</span> <span class="c1">#Eyring</span>
        <span class="k">elif</span> <span class="n">th</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">Absx</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span><span class="o">*</span><span class="n">abs_coeff</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="n">abs_coeff</span><span class="p">))</span> <span class="c1">#Modified by Xiang</span>
        <span class="n">Absx_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Absx_array</span><span class="p">,</span> <span class="n">Absx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Absx_array</span></div>



<span class="c1">#%%</span>
<span class="c1">###############################################################################</span>
<span class="c1">#CALCULATION OF EQUIVALENT ABSORPTION AREA</span>
<span class="c1">###############################################################################</span>
<span class="c1">#Absorption parameters for room</span>
<div class="viewcode-block" id="equiv_absorp">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.equiv_absorp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">equiv_absorp</span><span class="p">(</span><span class="n">alpha_1</span><span class="p">,</span> <span class="n">alpha_2</span><span class="p">,</span> <span class="n">alpha_3</span><span class="p">,</span> <span class="n">alpha_4</span><span class="p">,</span> <span class="n">alpha_5</span><span class="p">,</span> <span class="n">alpha_6</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">S3</span><span class="p">,</span> <span class="n">S4</span><span class="p">,</span> <span class="n">S5</span><span class="p">,</span> <span class="n">S6</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the eqauivalent absorption area</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        alpha_1 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 1</span>
<span class="sd">        alpha_2 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 2</span>
<span class="sd">        alpha_3 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 3</span>
<span class="sd">        alpha_4 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 4</span>
<span class="sd">        alpha_5 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 5</span>
<span class="sd">        alpha_6 : list</span>
<span class="sd">            Absrption coefficient for each frequency of Surface 6</span>
<span class="sd">        S1 : float</span>
<span class="sd">            Surface area of the Surface 1 (floor).</span>
<span class="sd">        S2 : float</span>
<span class="sd">            Surface area of the Surface 2 (ceiling).</span>
<span class="sd">        S3 : float</span>
<span class="sd">            Surface area of the Surface 3 (wall front).</span>
<span class="sd">        S4 : float</span>
<span class="sd">            Surface area of the Surface 4 (wall back).</span>
<span class="sd">        S5 : float</span>
<span class="sd">            Surface area of the Surface 5 (wall left).</span>
<span class="sd">        S6 : float</span>
<span class="sd">            Surface area of the Surface 6 (wall right).</span>
<span class="sd">        S : float</span>
<span class="sd">            Total surface area of the room</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        alpha_average : array of floats</span>
<span class="sd">            Average absorption coefficient per each frequency.</span>
<span class="sd">        Eq_A : array of floats</span>
<span class="sd">            Equivalent absorption area</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha_average</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_1</span><span class="p">,</span><span class="n">S1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_2</span><span class="p">,</span><span class="n">S2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_3</span><span class="p">,</span><span class="n">S3</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_4</span><span class="p">,</span><span class="n">S4</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_5</span><span class="p">,</span><span class="n">S5</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_6</span><span class="p">,</span><span class="n">S6</span><span class="p">))</span><span class="o">/</span><span class="n">S</span> <span class="c1">#average absorption</span>
    <span class="n">Eq_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_1</span><span class="p">,</span><span class="n">S1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_2</span><span class="p">,</span><span class="n">S2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_3</span><span class="p">,</span><span class="n">S3</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_4</span><span class="p">,</span><span class="n">S4</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_5</span><span class="p">,</span><span class="n">S5</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">alpha_6</span><span class="p">,</span><span class="n">S6</span><span class="p">)</span> <span class="c1">#equivalent absorption area of the room</span>
    <span class="k">return</span> <span class="n">alpha_average</span><span class="p">,</span> <span class="n">Eq_A</span></div>



<div class="viewcode-block" id="rec_sourceon_time">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.rec_sourceon_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rec_sourceon_time</span><span class="p">(</span><span class="n">nBands</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">Eq_A</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the time the sources stays on and the recording time</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nBands : int</span>
<span class="sd">            Number of frequency bands</span>
<span class="sd">        V : float</span>
<span class="sd">            Volume of the room</span>
<span class="sd">        Eq_A : array of floats</span>
<span class="sd">            Equivalent absorption</span>
<span class="sd">        dt : float</span>
<span class="sd">            Time step</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        RT_Sabine_band : list</span>
<span class="sd">            Reverberation time calculated with Sabine</span>
<span class="sd">        sourceon_time : float</span>
<span class="sd">            Time that the source stays on</span>
<span class="sd">        recording_time : float</span>
<span class="sd">            Length of the simulaton run</span>
<span class="sd">        t : array of floats</span>
<span class="sd">            Time array of time steps</span>
<span class="sd">        recording_steps : int</span>
<span class="sd">            Number of time steps</span>
<span class="sd">        sourceon_steps : int</span>
<span class="sd">            Number of time steps that the source is on.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RT_Sabine_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iBand</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nBands</span><span class="p">):</span>
        <span class="c1">#freq = center_freq[iBand]</span>
        <span class="n">RT_Sabine</span> <span class="o">=</span> <span class="mf">0.16</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">Eq_A</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span>
        <span class="n">RT_Sabine_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RT_Sabine</span><span class="p">)</span>

    <span class="n">sourceon_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">RT_Sabine_band</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="c1">#time that the source is ON before interrupting [s]</span>
    <span class="n">recording_time</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sourceon_time</span> <span class="c1">#total time recorded for the calculation [s]</span>
    <span class="c1">#Time resolution</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">recording_time</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c1">#mesh point in time</span>
    <span class="n">recording_steps</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">recording_time</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="c1">#number of time steps to consider in the calculation</span>
    <span class="n">sourceon_steps</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">sourceon_time</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="c1">#time steps at which the source is calculated/considered in the calculation</span>
    
    <span class="k">return</span> <span class="n">RT_Sabine_band</span><span class="p">,</span> <span class="n">sourceon_time</span><span class="p">,</span> <span class="n">recording_time</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">recording_steps</span><span class="p">,</span> <span class="n">sourceon_steps</span></div>



<div class="viewcode-block" id="diff_coeff">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.diff_coeff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">diff_coeff</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">c0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the theoretical diffusion coefficient</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        V : float</span>
<span class="sd">            Volume of the room</span>
<span class="sd">        S : float</span>
<span class="sd">            Total surface are of the room</span>
<span class="sd">        c0 : int</span>
<span class="sd">            Speed of sound </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        D_th : float </span>
<span class="sd">            Theoretical diffusion coefficient </span>
<span class="sd">        Dx : float </span>
<span class="sd">            Diffusion coefficient in the x direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dy : float </span>
<span class="sd">            Diffusion coefficient in the y direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dz : float</span>
<span class="sd">            Diffusion coefficient in the z direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_free_path</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">S</span> <span class="c1">#mean free path for 3D</span>
    <span class="c1">#mean_free_time = mean_free_path/c0 #mean free time for 3D</span>
    <span class="c1">#mean_free_time_step = int(mean_free_time/dt)</span>
    <span class="n">D_th</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_free_path</span><span class="o">*</span><span class="n">c0</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">Dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_free_path</span><span class="o">*</span><span class="n">c0</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="c1">#diffusion coefficient for proportionate rooms x direction</span>
    <span class="n">Dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_free_path</span><span class="o">*</span><span class="n">c0</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="c1">#diffusion coefficient for proportionate rooms y direction</span>
    <span class="n">Dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_free_path</span><span class="o">*</span><span class="n">c0</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="c1">#diffusion coefficient for proportionate rooms z direction</span>
    <span class="k">return</span> <span class="n">D_th</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">Dz</span></div>



<span class="c1">#Mesh numbers</span>
<div class="viewcode-block" id="beta_zero_fun">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.beta_zero_fun">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">beta_zero_fun</span><span class="p">(</span><span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">Dz</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of factor beta_zero</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        Dx : float</span>
<span class="sd">            Diffusion coefficient in the x direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dy : float</span>
<span class="sd">            Diffusion coefficient in the y direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dz : float</span>
<span class="sd">            Diffusion coefficient in the z direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        dx : float</span>
<span class="sd">            distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">        dy : float</span>
<span class="sd">            distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">        dz : float</span>
<span class="sd">            distance step between mesh points in the z axis (recommended equal to dx)</span>
<span class="sd">        dt : float</span>
<span class="sd">            Time step</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        beta_zero_x : float</span>
<span class="sd">            Coefficient beta zero in the x axis used in the calculation of the energy density</span>
<span class="sd">        beta_zero_y : float</span>
<span class="sd">            Coefficient beta zero in the y axis used in the calculation of the energy density</span>
<span class="sd">        beta_zero_z : float</span>
<span class="sd">            Coefficient beta zero in the z axis used in the calculation of the energy density</span>
<span class="sd">        beta_zero : float</span>
<span class="sd">            Sum of the coefficients beta_zero_x, beta_zero_y and beta_zero_z</span>
<span class="sd">        beta_zero_condition: float</span>
<span class="sd">            If this value is more than 1, it flags it up as an error for possible inconvergence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">beta_zero_x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Dx</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#mesh number in x direction</span>
    <span class="n">beta_zero_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Dy</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#mesh number in x direction</span>
    <span class="n">beta_zero_z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Dz</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#mesh number in x direction</span>
    <span class="n">beta_zero</span> <span class="o">=</span> <span class="n">beta_zero_x</span> <span class="o">+</span> <span class="n">beta_zero_y</span> <span class="o">+</span> <span class="n">beta_zero_z</span> <span class="c1">#beta_zero is the condition for all the directions deltax, deltay and deltaz.</span>
    <span class="c1">#Condition for the model to be unconditionally stable</span>
    <span class="n">beta_zero_condition</span> <span class="o">=</span> <span class="p">((</span><span class="n">beta_zero</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">beta_zero</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">beta_zero</span><span class="p">))</span> <span class="c1">#from Navarro 2012 paper</span>
    <span class="k">if</span> <span class="n">beta_zero_condition</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aa! error! Check beta condition&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">beta_zero_x</span><span class="p">,</span> <span class="n">beta_zero_y</span><span class="p">,</span> <span class="n">beta_zero_z</span><span class="p">,</span> <span class="n">beta_zero</span><span class="p">,</span> <span class="n">beta_zero_condition</span></div>

 
    
<span class="c1">#Initial condition - Source Info (interrupted method)</span>
<div class="viewcode-block" id="initial_condition">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.initial_condition">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">initial_condition</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">Ws</span><span class="p">,</span> <span class="n">sourceon_steps</span><span class="p">,</span> <span class="n">recording_steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Definition of initial conditions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        dx : float</span>
<span class="sd">            distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">        dy : float</span>
<span class="sd">            distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">        dz : float</span>
<span class="sd">            distance step between mesh points in the z axis (recommended equal to dx)</span>
<span class="sd">        Ws : float</span>
<span class="sd">            Power of the source</span>
<span class="sd">        sourceon_steps : int</span>
<span class="sd">            Number of time steps that the source stays on</span>
<span class="sd">        recording_steps : int</span>
<span class="sd">            Number of time steps</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Vs : float</span>
<span class="sd">            Volume of the source</span>
<span class="sd">        w1 : float</span>
<span class="sd">            Power density of the source [Watts/(m^3))]</span>
<span class="sd">        s1 : array of floats</span>
<span class="sd">            Energy density of source number 1 at each source on time step position</span>
<span class="sd">        source1 : array of floats</span>
<span class="sd">            Energy density of source number 1 at time step position</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Vs</span><span class="o">=</span><span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dz</span>  <span class="c1">#Volume of the source</span>
    <span class="n">w1</span><span class="o">=</span><span class="n">Ws</span><span class="o">/</span><span class="n">Vs</span> <span class="c1">#w1 = round(Ws/Vs,4) #power density of the source [Watts/(m^3))]</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sourceon_steps</span><span class="p">))</span> <span class="c1">#energy density of source number 1 at each time step position</span>
    <span class="n">source1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">recording_steps</span><span class="o">-</span><span class="n">sourceon_steps</span><span class="p">))</span> <span class="c1">#This would be equal to s1 if and only if recoding_steps = sourceon_steps</span>
    <span class="k">return</span> <span class="n">Vs</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">source1</span></div>



<span class="c1">###############################################################################</span>
<span class="c1">#SOURCE INTERPOLATION</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="source_interpolation">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.source_interpolation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">source_interpolation</span><span class="p">(</span><span class="n">coord_source</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">source1</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolation of source position</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        coord_source : list</span>
<span class="sd">            Coordinates of the source position</span>
<span class="sd">        dx : float</span>
<span class="sd">            distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">        dy : float</span>
<span class="sd">            distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">        dz : float</span>
<span class="sd">            distance step between mesh points in the z axis (recommended equal to dx)</span>
<span class="sd">        source1 : array of floats</span>
<span class="sd">            Energy density of source number 1 at time step position</span>
<span class="sd">        Nx : int</span>
<span class="sd">            Number of mesh points in the x direction.</span>
<span class="sd">        Ny : int</span>
<span class="sd">            Number of mesh points in the y direction.</span>
<span class="sd">        Nz : int</span>
<span class="sd">            Number of mesh points in the z direction.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        s : array of floats</span>
<span class="sd">            Matrix of 3D mesh points inserting source energy</span>
<span class="sd">        row_lr_s : int </span>
<span class="sd">            Lower fractional index in the x direction of the source position</span>
<span class="sd">        row_up_s : int </span>
<span class="sd">            Upper fractional index in the x direction of the source position</span>
<span class="sd">        col_lr_s : int </span>
<span class="sd">            Lower fractional index in the y direction of the source position</span>
<span class="sd">        col_up_s : int </span>
<span class="sd">            Upper fractional index in the y direction of the source position</span>
<span class="sd">        dep_lr_s : int </span>
<span class="sd">            Lower fractional index in the z direction of the source position</span>
<span class="sd">        dep_up_s : int </span>
<span class="sd">            Upper fractional index in the z direction of the source position</span>
<span class="sd">        weight_row_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the x direction of the source position</span>
<span class="sd">        weight_row_up_s : float</span>
<span class="sd">            Upper interpolation weight in the x direction of the source position</span>
<span class="sd">        weight_col_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the y direction of the source position</span>
<span class="sd">        weight_col_up_s : float</span>
<span class="sd">            Upper interpolation weight in the y direction of the source position</span>
<span class="sd">        weight_dep_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the z direction of the source position</span>
<span class="sd">        weight_dep_up_s : float</span>
<span class="sd">            Upper interpolation weight in the z direction of the source position</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the fractional indices</span>
    <span class="n">row_lr_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span><span class="p">))</span>
    <span class="n">row_up_s</span> <span class="o">=</span> <span class="n">row_lr_s</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col_lr_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dy</span><span class="p">))</span>
    <span class="n">col_up_s</span> <span class="o">=</span> <span class="n">col_lr_s</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">dep_lr_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dz</span><span class="p">))</span>
    <span class="n">dep_up_s</span> <span class="o">=</span> <span class="n">dep_lr_s</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="c1"># Calculate the interpolation weights</span>
    <span class="n">weight_row_up_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">row_lr_s</span>
    <span class="n">weight_row_lr_s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_row_up_s</span>
    <span class="n">weight_col_up_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dy</span><span class="p">)</span> <span class="o">-</span> <span class="n">col_lr_s</span>
    <span class="n">weight_col_lr_s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_col_up_s</span>
    <span class="n">weight_dep_up_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_source</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dz</span><span class="p">)</span> <span class="o">-</span> <span class="n">dep_lr_s</span>
    <span class="n">weight_dep_lr_s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_dep_up_s</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span> <span class="c1">#matrix of zeros for source</span>
    
    <span class="c1"># Perform linear interpolation</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span>
    <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">row_lr_s</span><span class="p">,</span> <span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">,</span> <span class="n">weight_row_lr_s</span><span class="p">,</span> <span class="n">weight_row_up_s</span><span class="p">,</span> <span class="n">weight_col_lr_s</span><span class="p">,</span> <span class="n">weight_col_up_s</span><span class="p">,</span> <span class="n">weight_dep_lr_s</span><span class="p">,</span> <span class="n">weight_dep_up_s</span></div>




<span class="c1">###############################################################################</span>
<span class="c1">#RECEIVER INTERPOLATION</span>
<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="receiver_interpolation">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.receiver_interpolation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">receiver_interpolation</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolation of receiver position</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        coord_rec : list</span>
<span class="sd">            Coordinates of the receiver position</span>
<span class="sd">        dx : float</span>
<span class="sd">            distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">        dy : float</span>
<span class="sd">            distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">        dz : float</span>
<span class="sd">            distance step between mesh points in the z axis (recommended equal to dx)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        row_lr_r : int </span>
<span class="sd">            Lower fractional index in the x direction of the receiver position</span>
<span class="sd">        row_up_r : int </span>
<span class="sd">            Upper fractional index in the x direction of the receiver position</span>
<span class="sd">        col_lr_r : int </span>
<span class="sd">            Lower fractional index in the y direction of the receiver position</span>
<span class="sd">        col_up_r : int </span>
<span class="sd">            Upper fractional index in the y direction of the receiver position</span>
<span class="sd">        dep_lr_r : int </span>
<span class="sd">            Lower fractional index in the z direction of the receiver position</span>
<span class="sd">        dep_up_r : int </span>
<span class="sd">            Upper fractional index in the z direction of the receiver position</span>
<span class="sd">        weight_row_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_row_up_r : float</span>
<span class="sd">            Upper interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_col_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_col_up_r : float</span>
<span class="sd">            Upper interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_dep_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the z direction of the receiver position</span>
<span class="sd">        weight_dep_up_rs : float</span>
<span class="sd">            Upper interpolation weight in the z direction of the receiver position</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Calculate the fractional indices for receiver</span>
    <span class="n">row_lr_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span><span class="p">))</span>
    <span class="n">row_up_r</span> <span class="o">=</span> <span class="n">row_lr_r</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col_lr_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dy</span><span class="p">))</span>
    <span class="n">col_up_r</span> <span class="o">=</span> <span class="n">col_lr_r</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">dep_lr_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dz</span><span class="p">))</span>
    <span class="n">dep_up_r</span> <span class="o">=</span> <span class="n">dep_lr_r</span> <span class="o">+</span> <span class="mi">1</span>
       
    <span class="c1">#Calculate the interpolation weights for receiver</span>
    <span class="n">weight_row_up_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">row_lr_r</span> <span class="c1">#weight x upper</span>
    <span class="n">weight_row_lr_r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_row_up_r</span> <span class="c1">#weight x lower</span>
    <span class="n">weight_col_up_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dy</span><span class="p">)</span> <span class="o">-</span> <span class="n">col_lr_r</span> <span class="c1">#weight y upper</span>
    <span class="n">weight_col_lr_r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_col_up_r</span> <span class="c1">#weight y lower</span>
    <span class="n">weight_dep_up_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dz</span><span class="p">)</span> <span class="o">-</span> <span class="n">dep_lr_r</span> <span class="c1">#weight z upper</span>
    <span class="n">weight_dep_lr_r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight_dep_up_r</span> <span class="c1">#weight z lower</span>
    
    <span class="k">return</span> <span class="n">row_lr_r</span><span class="p">,</span> <span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">,</span> <span class="n">weight_row_lr_r</span><span class="p">,</span> <span class="n">weight_row_up_r</span><span class="p">,</span> <span class="n">weight_col_lr_r</span><span class="p">,</span> <span class="n">weight_col_up_r</span><span class="p">,</span> <span class="n">weight_dep_lr_r</span><span class="p">,</span> <span class="n">weight_dep_up_r</span></div>




<div class="viewcode-block" id="dist_source_receiver">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.dist_source_receiver">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dist_source_receiver</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">,</span> <span class="n">coord_source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculation of the distance between source and receiver positions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        coord_rec : list </span>
<span class="sd">            Coordinates of the receiver position</span>
<span class="sd">        coord_source : list</span>
<span class="sd">            Coordinates of the source position</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dist_sr : float</span>
<span class="sd">            Distance between source and receiver position</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#distance between source and receiver</span>
    <span class="n">dist_sr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coord_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#distance between source and receiver</span>
    <span class="k">return</span> <span class="n">dist_sr</span></div>




<div class="viewcode-block" id="dist_source_x_y">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.dist_source_x_y">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dist_source_x_y</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">row_lr_r</span><span class="p">,</span> <span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">,</span> <span class="n">weight_row_lr_r</span><span class="p">,</span> <span class="n">weight_row_up_r</span><span class="p">,</span> <span class="n">weight_col_lr_r</span><span class="p">,</span> <span class="n">weight_col_up_r</span><span class="p">,</span> <span class="n">weight_dep_lr_r</span><span class="p">,</span> <span class="n">weight_dep_up_r</span><span class="p">,</span> <span class="n">coord_source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcualtion of distance source and receiver on a line in the x and y directions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        xx : array of floats</span>
<span class="sd">            3D matrix for the x coordinates</span>
<span class="sd">        yy : array of floats</span>
<span class="sd">            3D matrix for the y coordinates</span>
<span class="sd">        zz : array of floats</span>
<span class="sd">            3D matrix for the z coordinates</span>
<span class="sd">        row_lr_r : int </span>
<span class="sd">            Lower fractional index in the x direction of the receiver position</span>
<span class="sd">        row_up_r : int </span>
<span class="sd">            Upper fractional index in the x direction of the receiver position</span>
<span class="sd">        col_lr_r : int </span>
<span class="sd">            Lower fractional index in the y direction of the receiver position</span>
<span class="sd">        col_up_r : int </span>
<span class="sd">            Upper fractional index in the y direction of the receiver position</span>
<span class="sd">        dep_lr_r : int </span>
<span class="sd">            Lower fractional index in the z direction of the receiver position</span>
<span class="sd">        dep_up_r : int </span>
<span class="sd">            Upper fractional index in the z direction of the receiver position</span>
<span class="sd">        weight_row_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_row_up_r : float</span>
<span class="sd">            Upper interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_col_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_col_up_r : float</span>
<span class="sd">            Upper interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_dep_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the z direction of the receiver position</span>
<span class="sd">        weight_dep_up_r : float</span>
<span class="sd">            Upper interpolation weight in the z direction of the receiver position</span>
<span class="sd">        coord_source : list</span>
<span class="sd">            Coordinates of the source position</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dist_x : array of floats</span>
<span class="sd">            Distance between source and each mesh point in the x direction on a line </span>
<span class="sd">        dist_y : array of floats</span>
<span class="sd">            Distance between source and each mesh point in the y direction on a line </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#distance between source and each mesh point in the x direction </span>
    <span class="n">dist_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((((</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
        <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
            <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">xx</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>\
                     <span class="p">(((</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span><span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                         <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                             <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                 <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                     <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                         <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                             <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                                 <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>\
                         <span class="p">(((</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                             <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                 <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                     <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                         <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                             <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                                 <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                                     <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    
    <span class="c1">#distance between source and each mesh point in the y direction  </span>
    <span class="n">dist_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((((</span><span class="n">xx</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
        <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
            <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>\
                     <span class="p">(((</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span><span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                         <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                             <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                 <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                     <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                         <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                             <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                                 <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>\
                         <span class="p">(((</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                             <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                 <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                     <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                         <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                             <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                                 <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                                     <span class="p">(</span><span class="n">zz</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span> <span class="o">-</span> <span class="n">coord_source</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dist_x</span><span class="p">,</span> <span class="n">dist_y</span></div>


<span class="c1">#%%</span>
<span class="c1">###############################################################################</span>
<span class="c1">#MAIN CALCULATION - COMPUTING ENERGY DENSITY</span>
<span class="c1">############################################################################### </span>

<div class="viewcode-block" id="comput_energy_density">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.comput_energy_density">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">comput_energy_density</span><span class="p">(</span><span class="n">nBands</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">m_atm</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">recording_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">recording_time</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">beta_zero</span><span class="p">,</span> 
                             <span class="n">beta_zero_x</span> <span class="p">,</span> <span class="n">beta_zero_y</span><span class="p">,</span> <span class="n">beta_zero_z</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">Dz</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sourceon_time</span><span class="p">,</span> <span class="n">sourceon_steps</span><span class="p">,</span>
                             <span class="n">Abs_1</span><span class="p">,</span> <span class="n">Abs_2</span><span class="p">,</span> <span class="n">Abs_3</span><span class="p">,</span> <span class="n">Abs_4</span><span class="p">,</span> <span class="n">Abs_5</span><span class="p">,</span> <span class="n">Abs_6</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">source1</span><span class="p">,</span> 
                             <span class="n">row_lr_s</span><span class="p">,</span> <span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">,</span> 
                             <span class="n">weight_row_lr_s</span><span class="p">,</span> <span class="n">weight_row_up_s</span><span class="p">,</span> <span class="n">weight_col_lr_s</span><span class="p">,</span> <span class="n">weight_col_up_s</span><span class="p">,</span> <span class="n">weight_dep_lr_s</span><span class="p">,</span> <span class="n">weight_dep_up_s</span><span class="p">,</span> 
                             <span class="n">row_lr_r</span><span class="p">,</span> <span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">,</span> 
                             <span class="n">weight_row_lr_r</span><span class="p">,</span> <span class="n">weight_row_up_r</span><span class="p">,</span> <span class="n">weight_col_lr_r</span><span class="p">,</span> <span class="n">weight_col_up_r</span><span class="p">,</span> <span class="n">weight_dep_lr_r</span><span class="p">,</span> <span class="n">weight_dep_up_r</span><span class="p">,</span> 
                             <span class="n">tcalc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computation of energy density</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nBands : int</span>
<span class="sd">            Number of frequency bands</span>
<span class="sd">        c0 : int </span>
<span class="sd">            Speed of sound</span>
<span class="sd">        m_atm : float</span>
<span class="sd">            Air absorption coefficient</span>
<span class="sd">        Nx : int</span>
<span class="sd">            Number of mesh points in the x direction.</span>
<span class="sd">        Ny : int</span>
<span class="sd">            Number of mesh points in the y direction.</span>
<span class="sd">        Nz : int</span>
<span class="sd">            Number of mesh points in the z direction.</span>
<span class="sd">        recording_steps : int </span>
<span class="sd">            Number of time steps</span>
<span class="sd">        x : array of floats</span>
<span class="sd">            Linspace of the mesh point in the x axis.</span>
<span class="sd">        y : array of floats</span>
<span class="sd">            Linspace of the mesh point in the y axis.</span>
<span class="sd">        z : array of floats</span>
<span class="sd">            Linspace of the mesh point in the z axis.</span>
<span class="sd">        recording_time : float</span>
<span class="sd">            Length of the simulaton run</span>
<span class="sd">        dt : float</span>
<span class="sd">            Time step</span>
<span class="sd">        beta_zero : float</span>
<span class="sd">            Sum of the coefficients beta_zero_x, beta_zero_y and beta_zero_z</span>
<span class="sd">        beta_zero_x : float</span>
<span class="sd">            Coefficient beta zero in the x axis used in the calculation of the energy density</span>
<span class="sd">        beta_zero_y : float</span>
<span class="sd">            Coefficient beta zero in the y axis used in the calculation of the energy density</span>
<span class="sd">        beta_zero_z : float</span>
<span class="sd">            Coefficient beta zero in the z axis used in the calculation of the energy density</span>
<span class="sd">        dx : float</span>
<span class="sd">            distance step between mesh points in the x axis (recommended 0.5)</span>
<span class="sd">        dy : float</span>
<span class="sd">            distance step between mesh points in the y axis (recommended equal to dx)</span>
<span class="sd">        dz : float</span>
<span class="sd">            distance step between mesh points in the z axis (recommended equal to dx)</span>
<span class="sd">        Dx : float</span>
<span class="sd">            Diffusion coefficient in the x direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dy : float</span>
<span class="sd">            Diffusion coefficient in the y direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        Dz : float</span>
<span class="sd">            Diffusion coefficient in the z direction (equal to the theoretical diffusion coefficient)</span>
<span class="sd">        t : array of floats</span>
<span class="sd">            Time array of time steps</span>
<span class="sd">        sourceon_time : float</span>
<span class="sd">            Time that the source stays on</span>
<span class="sd">        sourceon_steps : int</span>
<span class="sd">            Number of time steps that the source stays on</span>
<span class="sd">        Abs_1 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 1 for each frequency</span>
<span class="sd">        Abs_2 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 2 for each frequency</span>
<span class="sd">        Abs_3 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 3 for each frequency        </span>
<span class="sd">        Abs_4 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 4 for each frequency</span>
<span class="sd">        Abs_5 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 5 for each frequency</span>
<span class="sd">        Abs_6 : array of floats</span>
<span class="sd">            Calculated absorption term for Surface 6 for each frequency</span>
<span class="sd">        s : array of floats</span>
<span class="sd">            Matrix of 3D mesh points inserting source energy</span>
<span class="sd">        source1 : array of floats</span>
<span class="sd">            Energy density of source number 1 at time step position</span>
<span class="sd">        row_lr_s : int </span>
<span class="sd">            Lower fractional index in the x direction of the source position</span>
<span class="sd">        row_up_s : int </span>
<span class="sd">            Upper fractional index in the x direction of the source position</span>
<span class="sd">        col_lr_s : int </span>
<span class="sd">            Lower fractional index in the y direction of the source position</span>
<span class="sd">        col_up_s : int </span>
<span class="sd">            Upper fractional index in the y direction of the source position</span>
<span class="sd">        dep_lr_s : int </span>
<span class="sd">            Lower fractional index in the z direction of the source position</span>
<span class="sd">        dep_up_s : int </span>
<span class="sd">            Upper fractional index in the z direction of the source position</span>
<span class="sd">        weight_row_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the x direction of the source position</span>
<span class="sd">        weight_row_up_s : float</span>
<span class="sd">            Upper interpolation weight in the x direction of the source position</span>
<span class="sd">        weight_col_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the y direction of the source position</span>
<span class="sd">        weight_col_up_s : float</span>
<span class="sd">            Upper interpolation weight in the y direction of the source position</span>
<span class="sd">        weight_dep_lr_s : float</span>
<span class="sd">            Lower interpolation weight in the z direction of the source position</span>
<span class="sd">        weight_dep_up_s : float</span>
<span class="sd">            Upper interpolation weight in the z direction of the source position</span>
<span class="sd">        row_lr_r : int </span>
<span class="sd">            Lower fractional index in the x direction of the receiver position</span>
<span class="sd">        row_up_r : int </span>
<span class="sd">            Upper fractional index in the x direction of the receiver position</span>
<span class="sd">        col_lr_r : int </span>
<span class="sd">            Lower fractional index in the y direction of the receiver position</span>
<span class="sd">        col_up_r : int </span>
<span class="sd">            Upper fractional index in the y direction of the receiver position</span>
<span class="sd">        dep_lr_r : int </span>
<span class="sd">            Lower fractional index in the z direction of the receiver position</span>
<span class="sd">        dep_up_r : int </span>
<span class="sd">            Upper fractional index in the z direction of the receiver position</span>
<span class="sd">        weight_row_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_row_up_r : float</span>
<span class="sd">            Upper interpolation weight in the x direction of the receiver position</span>
<span class="sd">        weight_col_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_col_up_r : float</span>
<span class="sd">            Upper interpolation weight in the y direction of the receiver position</span>
<span class="sd">        weight_dep_lr_r : float</span>
<span class="sd">            Lower interpolation weight in the z direction of the receiver position</span>
<span class="sd">        weight_dep_up_r : float</span>
<span class="sd">            Upper interpolation weight in the z direction of the receiver position</span>
<span class="sd">        tcalc : str</span>
<span class="sd">            Type of calculation; &quot;decay&quot; if the source switches off and &quot;stationarysource&quot; if the source is stationary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        w_new_band : array of floats</span>
<span class="sd">            Energy density at the time step n+1 at each mesh point per each frequency band</span>
<span class="sd">        w_t0_band : array of floats</span>
<span class="sd">            Energy density at the time step t=0 (when the source is switched off) at each mesh point per each frequency band</span>
<span class="sd">        w_rec_band : array of floats</span>
<span class="sd">            Energy density over time at the receiver position per each frequency band</span>
<span class="sd">        w_rec_off_band : list of arrays</span>
<span class="sd">            Energy density over time after the source is switched off at the receiver position per each frequency band</span>
<span class="sd">        w_rec_x_t0_band : array of floats</span>
<span class="sd">            Energy density at the time step t=0 (when the source is switched off) in the line receivers per each frequency band</span>
<span class="sd">        idx_w_rec : int</span>
<span class="sd">            Time index at which the source is switched off</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w_new_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nBands</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
    <span class="n">w_t0_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nBands</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
    <span class="n">w_rec_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nBands</span><span class="p">,</span> <span class="n">recording_steps</span><span class="p">))</span>
    <span class="n">w_rec_off_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">w_rec_x_t0_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nBands</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    
    <span class="n">curPercent</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1">#Computing w;</span>
    <span class="k">for</span> <span class="n">iBand</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nBands</span><span class="p">):</span>
        <span class="c1">#freq = center_freq[iBand]  </span>
        
        <span class="n">w_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">))</span> <span class="c1">#unknown w at new time level (n+1)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#w at n level</span>
        <span class="n">w_old</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#w_old at n-1 level</span>
        <span class="c1"># w = w_new #w at n level</span>
        <span class="c1"># w_old = w #w_old at n-1 level</span>
    
        <span class="n">w_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">recording_time</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span> <span class="c1">#energy density at the receiver</span>
        <span class="n">w_rec_x_t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> 
        
        <span class="k">for</span> <span class="n">steps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">recording_steps</span><span class="p">):</span>
            <span class="c1">#Compute w at inner mesh points</span>
            <span class="n">time_steps</span> <span class="o">=</span> <span class="n">steps</span><span class="o">*</span><span class="n">dt</span> <span class="c1">#total time for the calculation</span>
            
            <span class="c1">#In the x direction</span>
            <span class="n">w_iminus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span>
            <span class="n">w_m_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_iminus1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
            <span class="n">w_m_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_m_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Expand the dimensions of w_m_i to match the shape of w_iminus1</span>
            <span class="n">w_iminus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_m_i</span><span class="p">,</span><span class="n">w_iminus1</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
            <span class="n">w_iplus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span>
            <span class="n">w_p_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_iplus1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:])</span>
            <span class="n">w_p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_p_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Expand the dimensions of w_p_i to match the shape of w_iplus1</span>
            <span class="n">w_iplus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_iplus1</span><span class="p">,</span><span class="n">w_p_i</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#In the y direction</span>
            <span class="n">w_jminus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Ny</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span>
            <span class="n">w_m_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_jminus1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">w_m_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_m_j</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#Expand the dimensions of w_m_j to match the shape of w_jminus1</span>
            <span class="n">w_jminus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_m_j</span><span class="p">,</span> <span class="n">w_jminus1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">w_jplus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span>
            <span class="n">w_p_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_jplus1</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
            <span class="n">w_p_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_p_j</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#Expand the dimensions of w_p_j to match the shape of w_jplus1</span>
            <span class="n">w_jplus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_jplus1</span><span class="p">,</span><span class="n">w_p_j</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1">#In the z direction</span>
            <span class="n">w_kminus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">w_m_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_kminus1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">w_m_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_m_k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Expand the dimensions of w_m_k to match the shape of w_kminus1</span>
            <span class="n">w_kminus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_m_k</span><span class="p">,</span> <span class="n">w_kminus1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="n">w_kplus1</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span>
            <span class="n">w_p_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_kplus1</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">w_p_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w_p_k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#Expand the dimensions of w_p_k to match the shape of w_kplus1</span>
            <span class="n">w_kplus1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_kplus1</span><span class="p">,</span><span class="n">w_p_k</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="c1">#Computing w_new (w at n+1 time step)</span>
            <span class="n">w_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w_old</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">beta_zero</span><span class="p">))),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">c0</span><span class="o">*</span><span class="n">m_atm</span><span class="o">*</span><span class="n">w</span><span class="p">),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span> <span class="o">+</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="n">s</span><span class="p">),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span> <span class="o">+</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">beta_zero_x</span><span class="p">,(</span><span class="n">w_iplus1</span><span class="o">+</span><span class="n">w_iminus1</span><span class="p">))),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span> <span class="o">+</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">beta_zero_y</span><span class="p">,(</span><span class="n">w_jplus1</span><span class="o">+</span><span class="n">w_jminus1</span><span class="p">))),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span> <span class="o">+</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">beta_zero_z</span><span class="p">,(</span><span class="n">w_kplus1</span><span class="o">+</span><span class="n">w_kminus1</span><span class="p">))),(</span><span class="mi">1</span><span class="o">+</span><span class="n">beta_zero</span><span class="p">))</span>
            
            <span class="c1">#Insert boundary conditions  </span>
            <span class="n">w_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_5</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dx</span><span class="p">)))</span> <span class="c1">#boundary condition at x=0, any y, any z</span>
            <span class="n">w_new</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,:,:]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_6</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dx</span><span class="p">)))</span> <span class="c1">#boundary condition at lx=length, any y, any z</span>
        
        
            <span class="n">w_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,:]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_3</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dy</span><span class="p">)))</span> <span class="c1">#boundary condition at y=0, any x, any z</span>
            <span class="n">w_new</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">,:]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_4</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dy</span><span class="p">)))</span> <span class="c1">#boundary condition at at ly=width, any x, any z</span>
         
            
            <span class="n">w_new</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_1</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dz</span><span class="p">)))</span> <span class="c1">#boundary condition at z=0, any x, any y</span>
            <span class="n">w_new</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">w_new</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_new</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">3</span><span class="p">]),(</span><span class="mi">3</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">Abs_2</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">Dz</span><span class="p">)))</span> <span class="c1">#boundary condition at at lz=height, any x, any y</span>
            
            <span class="c1">#sdl = 10*np.log10(abs(w_new),where=abs(w_new)&gt;0) #sound density level</span>
            <span class="c1">#spl = 10*np.log10(((abs(w_new))*rho*(c0**2))/(pRef**2)) #,where=press_r&gt;0, sound pressure level in the 3D space</span>
                  
            <span class="c1">#Update w before next step</span>
            <span class="n">w_old</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#The w at n step becomes the w at n-1 step</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#The w at n+1 step becomes the w at n step</span>
    
            <span class="c1"># w_old = w #The w at n step becomes the w at n-1 step</span>
            <span class="c1"># w = w_new #The w at n+1 step becomes the w at n step</span>
            
            <span class="c1">#w_rec is the energy density at the specific receiver</span>
            <span class="n">w_rec</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                    <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                        <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span>
            
            <span class="n">idx_w_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">sourceon_time</span><span class="p">))</span>
            <span class="n">w_rec_off</span> <span class="o">=</span> <span class="n">w_rec</span><span class="p">[</span><span class="n">idx_w_rec</span><span class="p">:]</span>
            
            <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="n">sourceon_steps</span><span class="p">:</span>
                <span class="c1">#print(&quot;Steps for source:&quot;,steps)</span>
                <span class="n">w_t0</span> <span class="o">=</span> <span class="n">w_new</span> 
            
            <span class="c1">#Updating the source term</span>
            <span class="k">if</span> <span class="n">tcalc</span> <span class="o">==</span> <span class="s2">&quot;decay&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tcalc</span> <span class="o">==</span> <span class="s2">&quot;stationarysource&quot;</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_lr_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_lr_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_lr_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_lr_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_lr_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_lr_s</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="n">row_up_s</span><span class="p">,</span> <span class="n">col_up_s</span><span class="p">,</span> <span class="n">dep_up_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_row_up_s</span> <span class="o">*</span> <span class="n">weight_col_up_s</span> <span class="o">*</span> <span class="n">weight_dep_up_s</span><span class="p">)</span>
            
            
            <span class="c1">#print(time_steps)</span>
            <span class="n">percentDone</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">time_steps</span><span class="o">/</span><span class="n">recording_time</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">percentDone</span> <span class="o">&gt;</span> <span class="n">curPercent</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curPercent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">% d</span><span class="s2">one&quot;</span><span class="p">)</span>
                <span class="n">curPercent</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                
            <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        
                    
        <span class="n">w_rec_x_t0</span> <span class="o">=</span> <span class="p">((</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
            <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                    <span class="p">(</span><span class="n">w_t0</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span>         
        
        <span class="n">w_new_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_new</span>
        <span class="n">w_t0_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_t0</span>
        <span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_rec</span>
        <span class="n">w_rec_off_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_rec_off</span><span class="p">)</span> 
        <span class="n">w_rec_x_t0_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_rec_x_t0</span>
    
    <span class="c1">#plt.show()</span>
    
    <span class="n">w_rec_x_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
        <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
            <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_lr_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">w_new</span><span class="p">[:,</span> <span class="n">col_up_r</span><span class="p">,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span>
        
    <span class="n">w_rec_y_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
        <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
            <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_lr_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_lr_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                    <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                        <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_lr_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">))</span><span class="o">+</span>\
                            <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_lr_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_lr_r</span><span class="p">))</span><span class="o">+</span>\
                                <span class="p">(</span><span class="n">w_new</span><span class="p">[</span><span class="n">row_up_r</span><span class="p">,</span> <span class="p">:,</span> <span class="n">dep_up_r</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">weight_row_up_r</span> <span class="o">*</span> <span class="n">weight_col_up_r</span> <span class="o">*</span> <span class="n">weight_dep_up_r</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">w_new_band</span><span class="p">,</span> <span class="n">w_t0_band</span><span class="p">,</span> <span class="n">w_rec_band</span><span class="p">,</span> <span class="n">w_rec_off_band</span><span class="p">,</span> <span class="n">w_rec_x_t0_band</span><span class="p">,</span> <span class="n">idx_w_rec</span></div>


<span class="c1">#%%</span>

<span class="c1">###############################################################################</span>
<span class="c1">#RESULTS</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="freq_param">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.freq_param">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">freq_param</span><span class="p">(</span><span class="n">nBands</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">pRef</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">Ws</span><span class="p">,</span> <span class="n">w_new_band</span><span class="p">,</span> <span class="n">w_t0_band</span><span class="p">,</span> <span class="n">w_rec_band</span><span class="p">,</span> <span class="n">w_rec_off_band</span><span class="p">,</span> <span class="n">w_rec_x_t0_band</span><span class="p">,</span> <span class="n">idx_w_rec</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dist_sr</span><span class="p">,</span> <span class="n">m_atm</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Eq_A</span><span class="p">,</span> <span class="n">tcalc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computation of sound presure level and reverberation time parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nBands : int</span>
<span class="sd">            Number of frequency bands</span>
<span class="sd">        rho : float </span>
<span class="sd">            Density of air</span>
<span class="sd">        pRef : float</span>
<span class="sd">            Reference pressure</span>
<span class="sd">        c0 : int</span>
<span class="sd">            Speed of sound</span>
<span class="sd">        Ws : float</span>
<span class="sd">            Power of the source</span>
<span class="sd">        w_new_band : array of floats</span>
<span class="sd">            Energy density at the time step n+1 at each mesh point per each frequency band</span>
<span class="sd">        w_t0_band : array of floats</span>
<span class="sd">            Energy density at the time step t=0 (when the source is switched off) at each mesh point per each frequency band</span>
<span class="sd">        w_rec_band : array of floats</span>
<span class="sd">            Energy density over time at the receiver position per each frequency band</span>
<span class="sd">        w_rec_off_band : list of arrays</span>
<span class="sd">            Energy density over time after the source is switched off at the receiver position per each frequency band</span>
<span class="sd">        w_rec_x_t0_band : array of floats</span>
<span class="sd">            Energy density at the time step t=0 (when the source is switched off) in the line receivers per each frequency band</span>
<span class="sd">        idx_w_rec : int</span>
<span class="sd">            Time index at which the source is switched off</span>
<span class="sd">        t : array of floats</span>
<span class="sd">            Time array of time steps</span>
<span class="sd">        dist_sr : float</span>
<span class="sd">            Distance between source and receiver position</span>
<span class="sd">        m_atm : float</span>
<span class="sd">            Air absorption coefficient</span>
<span class="sd">        V : float</span>
<span class="sd">            Volume of the room</span>
<span class="sd">        S : float</span>
<span class="sd">            Total surface area of the room</span>
<span class="sd">        Eq_A : array of floats</span>
<span class="sd">            Equivalent absorption</span>
<span class="sd">        tcalc : str</span>
<span class="sd">            Type of calculation; &quot;decay&quot; if the source switches off and &quot;stationarysource&quot; if the source is stationary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        spl_r_band : array of floats</span>
<span class="sd">            Sound pressure level over time at the receiver position per each frequency band</span>
<span class="sd">        spl_r_off_band : array of floats</span>
<span class="sd">            Sound pressure level over time after the source is switched off at the receiver position per each frequency band</span>
<span class="sd">        spl_r_norm_band : list of arrays</span>
<span class="sd">            Sound pressure level over time at the receiver position per each frequency band normalised to its maximum level</span>
<span class="sd">        sch_db_band : list of arrays</span>
<span class="sd">            Energy density over time after the source is switched off at the receiver position per each frequency band</span>
<span class="sd">        spl_t0_band : list of arrays</span>
<span class="sd">            Sound pressure level at the time step t= 0 (when the source is switched off) at the receiver position per each frequency band</span>
<span class="sd">        spl_new_band : list of arrays</span>
<span class="sd">            Sound pressure level at the time step n+1 per each mesh point per each frequency band</span>
<span class="sd">        spl_rec_x_t0_band : list of arrays</span>
<span class="sd">            Sound pressure level at the time step t= 0 (when the source is switched off) per each receiver position in a line per each frequency band</span>
<span class="sd">        t30_band : array of floats</span>
<span class="sd">            Reverberation time T30 per each frequency band</span>
<span class="sd">        edt_band : array of floats</span>
<span class="sd">            Early decay time per each frequency band</span>
<span class="sd">        c80_band : array of floats </span>
<span class="sd">            Clarity per each frequency band</span>
<span class="sd">        d50_band : array of floats </span>
<span class="sd">            Definition per each frequency band</span>
<span class="sd">        ts_band : array of floats</span>
<span class="sd">            Centre time per each frequency band</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spl_r_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_r_off_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_r_norm_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t30_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edt_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c80_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d50_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ts_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sch_db_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_new_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_t0_band</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spl_rec_x_t0_band</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="k">for</span> <span class="n">iBand</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nBands</span><span class="p">):</span>
     
        <span class="n">spl_t0</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_t0_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">spl_new</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_new_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">press_r</span> <span class="o">=</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#pressure at the receiver</span>
        <span class="n">spl_r</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#,where=press_r&gt;0, sound pressure level at the receiver</span>
        <span class="n">spl_r_off</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_off_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">spl_r_norm</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="p">(</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="c1">#normalised to maximum to 0dB</span>
        <span class="n">spl_r_tot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">c0</span><span class="o">*</span><span class="p">((</span><span class="n">Ws</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">dist_sr</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">m_atm</span><span class="o">*</span><span class="n">dist_sr</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]))</span><span class="o">*</span><span class="n">c0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#spl total (including direct field) at the receiver position????? but it will need to be calculated for a stationary source 100dB</span>
        
        <span class="n">spl_rec_x_t0</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">w_rec_x_t0_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">])</span><span class="o">/</span><span class="n">pRef</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1">#Schroeder integration</span>
        <span class="n">schroeder</span> <span class="o">=</span> <span class="n">w_rec_off_band</span><span class="p">[</span><span class="n">iBand</span><span class="p">]</span> <span class="c1">#energy_r_rev_cum[::-1] #reverting the array again -&gt; creating the schroder decay</span>
        <span class="n">sch_db</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">schroeder</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">schroeder</span><span class="p">))</span> <span class="c1">#level of the array: schroeder decay</span>
        
        <span class="k">if</span> <span class="n">tcalc</span> <span class="o">==</span> <span class="s2">&quot;decay&quot;</span><span class="p">:</span>
            <span class="n">t30</span> <span class="o">=</span> <span class="n">t60_decay</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sch_db</span><span class="p">,</span> <span class="n">idx_w_rec</span><span class="p">,</span> <span class="n">rt</span><span class="o">=</span><span class="s1">&#39;t30&#39;</span><span class="p">)</span> <span class="c1">#called function for calculation of t60 [s]</span>
            <span class="n">edt</span> <span class="o">=</span> <span class="n">t60_decay</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sch_db</span><span class="p">,</span> <span class="n">idx_w_rec</span><span class="p">,</span> <span class="n">rt</span><span class="o">=</span><span class="s1">&#39;edt&#39;</span><span class="p">)</span> <span class="c1">#called function for calculation of edt [s]</span>
            <span class="n">c80</span> <span class="o">=</span> <span class="n">clarity</span><span class="p">(</span><span class="n">t30</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">Eq_A</span><span class="p">[</span><span class="n">iBand</span><span class="p">],</span> <span class="n">S</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">dist_sr</span><span class="p">)</span> <span class="c1">#called function for calculation of c80 [dB]</span>
            <span class="n">d50</span> <span class="o">=</span> <span class="n">definition</span><span class="p">(</span><span class="n">t30</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">Eq_A</span><span class="p">[</span><span class="n">iBand</span><span class="p">],</span> <span class="n">S</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">dist_sr</span><span class="p">)</span> <span class="c1">#called function for calculation of d50 [%]</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">centretime</span><span class="p">(</span><span class="n">t30</span><span class="p">,</span> <span class="n">Eq_A</span><span class="p">[</span><span class="n">iBand</span><span class="p">],</span> <span class="n">S</span><span class="p">)</span> <span class="c1">#called function for calculation of ts [ms]</span>
        
            <span class="n">t30_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t30</span><span class="p">)</span>
            <span class="n">edt_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edt</span><span class="p">)</span>
            <span class="n">c80_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c80</span><span class="p">)</span>
            <span class="n">d50_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d50</span><span class="p">)</span>
            <span class="n">ts_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            
        <span class="n">spl_r_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_r</span><span class="p">)</span>
        <span class="n">spl_r_off_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_r_off</span><span class="p">)</span>
        <span class="n">spl_r_norm_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_r_norm</span><span class="p">)</span>
        <span class="n">sch_db_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sch_db</span><span class="p">)</span>
        <span class="n">spl_t0_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_t0</span><span class="p">)</span>
        <span class="n">spl_new_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_new</span><span class="p">)</span>
        <span class="n">spl_rec_x_t0_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spl_rec_x_t0</span><span class="p">)</span>
        
    <span class="n">spl_r_off_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spl_r_off_band</span><span class="p">)</span>
    <span class="n">t30_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t30_band</span><span class="p">)</span>
    <span class="n">edt_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edt_band</span><span class="p">)</span>
    <span class="n">c80_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c80_band</span><span class="p">)</span>
    <span class="n">d50_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d50_band</span><span class="p">)</span>
    <span class="n">ts_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ts_band</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">spl_r_band</span><span class="p">,</span> <span class="n">spl_r_off_band</span><span class="p">,</span> <span class="n">spl_r_norm_band</span><span class="p">,</span> <span class="n">sch_db_band</span><span class="p">,</span> <span class="n">spl_t0_band</span><span class="p">,</span> <span class="n">spl_new_band</span><span class="p">,</span> <span class="n">spl_rec_x_t0_band</span><span class="p">,</span> <span class="n">t30_band</span><span class="p">,</span> <span class="n">edt_band</span><span class="p">,</span> <span class="n">c80_band</span><span class="p">,</span> <span class="n">d50_band</span><span class="p">,</span> <span class="n">ts_band</span></div>


<span class="c1">#%%</span>
<span class="c1">###############################################################################</span>
<span class="c1">#SAVING</span>
<span class="c1">###############################################################################</span>
<span class="c1"># Save all variables to a file</span>
<div class="viewcode-block" id="save_fdm">
<a class="viewcode-back" href="../../../acousticDE/FDMfunctions.html#acousticDE.FiniteDifferenceMethod.FDMfunctions.save_fdm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_fdm</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">variables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saving of variables</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file to save the results</span>
<span class="sd">        variables : dict</span>
<span class="sd">            Compilation of all the variables of the overall simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Filter out modules, functions, and other unsupported types</span>
        <span class="n">filtered_variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if the object can be pickled</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="c1"># Exclude some types explicitly known to cause issues</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">LambdaType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MappingProxyType</span><span class="p">)):</span>
                    <span class="n">filtered_variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not pickle </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filtered_variables</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ilaria Fichera.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>